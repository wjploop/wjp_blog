---
title: “dart异步编程：Isolate和事件循环（译）
date: 2021-09-10 15:21:53
tags: code
categories:
---

> [原文](https://medium.com/dartlang/dart-asynchronous-programming-isolates-and-event-loops-bffc3e296a6a)

Dart, 尽管作为一个单线程语言，但也提供了一系列的API，诸如Future, Stream，来帮助我们编写一个现代、异步、响应式的程序。本文主要讲诉Dart再底层如何支持这样的后台任务，包括 isolate, 事件循环。

## Isolate

Isolate，指代码运行之处，指Dart程序所拥有的内存空间，以及在其之上运行的事件循环。

在一些类似C++的语言中，支持多个线程共享一段内存空间，每个线程也可以运行你想要的代码块（堆、方法区共享）。而在dart中，一个线程就是一个isolate和其所占的内存区，其线程只是一直在处理事件。

一般的Dart程序只是开启一个Isolate, 但也支持开启多个。若是有一个耗时任务在主线程中执行，会导致app丢帧，就可以用 `Isolsate.spawn()`, `Flutter的 compute()`方法，两者都会开启一个新得Isolate， 使得主Isolate忙于重建、渲染widget。

新的Isolate拥有自己的事件循环和内存空间，即使是由父类孵化(Spawn)出来的，父级也不允许访问孵化出来的Isolate。也就如其名所言，Isolate岛屿之意。

实际上，Isolate之间的交互只能通过相互发送信息。，相比Java/C++可以共享内存的机制而言，这种缺乏共享内存的设计可能看起来过于严格，效率不高。但却对Dart用于客户端语言来说，却有一定好处。比如，内存分配，垃圾回收不必需要使用锁了。因为只有一个线程，对于一个段内存空间而言，在某一个时刻，永远只会有一个CPU在访问。这样的特点，非常适用于Flutter程序，因为需要频繁的重建、销毁原来的widget对象。

## Event Loops 事件循环

以上简单介绍了Isolate，让我们继续探究一个单线程如何实现异步的，即事件循环。

想象一个app的生命周期，包括了开始、结束、和中间一些系列事件的发生，包括io事件、用户点击事件等。

你的程序并不能预测这些事件何时会发生，所以你只能开始时定义好收到什么事件时，该如何处理。

>> 不想继续翻译了，后面重复一个概念，告诉我们，所有无论是启动一个Callback、或开启一个Future，都是在添加一个事件处理到事件循环中，当其被调用时，只是收到了一个事件。



